{% extends "global/Page.html" %}

{% block title %}
  {% if is_ambiguity %}選択課題（確率不明）{% else %}選択課題{% endif %}
{% endblock %}

{% block content %}

<style>
  .instructions {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border-left: 6px solid #007bff;
    margin-bottom: 30px;
  }
  .table-mpl td { padding: 15px !important; vertical-align: middle; }
  .text-center { text-align: center; }
  .text-end { text-align: right; }
  input[type="radio"] { transform: scale(1.4); cursor: pointer; }
</style>

<div class="instructions">
  <p>以下の各行について、どちらか好きな方を選んでください。</p>
<p>くじの内容：<b>{{ lottery_text }}</b></p>
</div>

<table class="table table-hover table-mpl">
  <thead>
    <tr>
      <th>No.</th>
      <th class="text-center">選択A (確実)</th>
      <th class="text-center">A</th>
      <th class="text-center">B</th>
      <th class="text-center">選択B (くじ)</th>
    </tr>
  </thead>
  <tbody>
    {% for row in rows %}
    <tr>
      <td class="text-muted">{{ forloop.counter }}</td>
      <td class="text-end"><b>{{ row.label }}</b> を確実にもらう</td>
      <td class="text-center"><input type="radio" name="{{ row.field_name }}" value="2" required></td>
      <td class="text-center"><input type="radio" name="{{ row.field_name }}" value="1" required></td>
    <td>{{ lottery_text }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="text-center mt-5">
  <button type="button" class="btn btn-primary btn-lg px-5" onclick="submitChoices()">回答を送信して次へ</button>
</div>

<button class="otree-btn-next btn btn-primary" style="display:none;">Next</button>

<script>
  function submitChoices() {
    const choices = {};
    let allSelected = true;

    const names = new Set();
    document.querySelectorAll('input[type="radio"]').forEach(el => names.add(el.name));

    names.forEach(name => {
      const selected = document.querySelector(`input[name="${name}"]:checked`);
      if (!selected) {
        allSelected = false;
      } else {
        choices[name] = selected.value;
      }
    });

    if (!allSelected) {
      alert("未回答の行があります。");
      return;
    }

    const btn = document.querySelector('.btn-primary');
    btn.disabled = true;
    btn.innerText = "送信中...";

    liveSend({type: 'submit', choices: choices});
  }

  function liveRecv(data) {
    if (data && data.type === 'finished') {
      document.querySelector('.otree-btn-next').click();
    }
  }
</script>

{% endblock %}
